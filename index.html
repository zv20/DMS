<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–î–µ—Ç—Å–∫–æ –º–µ–Ω—é</title>
  
  <link rel="stylesheet" href="css/styles.css?v=14.7">
  <link rel="stylesheet" href="css/template-styles.css?v=14.7">
  
  <!-- PDF Generation Libraries (Local) -->
  <script src="js/libs/html2canvas.min.js"></script>
  <script src="js/libs/jspdf.umd.min.js"></script>
  
  <!-- Core Application Scripts -->
  <script src="js/i18n.js?v=14.7"></script>
  <script src="js/constants.js?v=14.7"></script>
  
  <!-- STORAGE ADAPTER (must load before store.js) -->
  <script src="js/storage-adapter.js?v=14.7"></script>
  <script src="js/store.js?v=14.7"></script>
  
  <script src="js/calendar.js?v=14.7"></script>
  <script src="js/render.js?v=14.7"></script>
  <script src="js/ui.js?v=14.7"></script>
  <script src="js/ui-combobox.js?v=14.7"></script>
  <script src="js/clock.js?v=14.7"></script>
  
  <!-- NEW STEP-BASED TEMPLATE BUILDER (Accordion UI with Header/Footer Images) -->
  <script src="js/template/template-builder-steps.js?v=14.7"></script>
  
  <!-- PRINT FUNCTIONALITY -->
  <script src="js/print.js?v=14.7"></script>
  
  <script src="js/main.js?v=14.7"></script>

  <style>
    /* ‚îÄ‚îÄ Sortable recipe table headers ‚îÄ‚îÄ */
    .sortable-th {
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }
    .sortable-th:hover { color: #fd7e14; }
    .sort-arrow { font-style: normal; font-size: 0.8em; }
  </style>
</head>
<body data-theme="default">

  <!-- Splash Screen -->
  <div id="splashScreen" class="splash-screen">
      <div class="splash-content">
          <img src="img/logo.png" alt="Logo" class="splash-logo" style="width: 200px; height: 200px; object-fit: contain; display: block; margin: 0 auto 20px;">
          <h1 class="splash-title" data-i18n="splash_title">–î–µ—Ç—Å–∫–æ –º–µ–Ω—é</h1>
          <p class="splash-subtitle" data-i18n="splash_subtitle"></p>
          <div id="splashActions" class="splash-actions">
              <div class="loader-spinner"></div>
          </div>
      </div>
  </div>

  <!-- Header -->
  <header class="app-header">
      <div style="display:flex; align-items:center; gap:1rem;">
          <button id="hamburgerBtn" class="hamburger-btn" aria-label="Open Menu">
              <span></span>
              <span></span>
              <span></span>
          </button>
          <div class="logo" style="margin-left: 50px; display: flex; align-items: center; gap: 10px;">
            <img src="img/logo.png" alt="Logo" style="width: 40px; height: 40px; object-fit: contain;">
          </div>
      </div>
      <div class="header-right">
           <div id="syncIndicator" class="sync-indicator sync-hidden" title="Saved">‚úì</div>
           <div id="liveClock" class="live-clock">
               <div class="clock-time">Loading...</div>
               <div class="clock-date"></div>
           </div>
           <select id="languageSelect" class="lang-select-minimal">
              <option value="bg">üáßüá¨</option>
              <option value="en">üá∫üá∏</option>
           </select>
      </div>
  </header>

  <!-- Navigation Overlay -->
  <div id="navOverlay" class="nav-overlay">
      <button id="closeNavBtn" class="close-nav-btn">&times;</button>
      <div class="nav-content">
          <div class="nav-links">
              <button class="nav-item active" data-page="menu" data-i18n="nav_menu">Menu Planner</button>
              <div class="nav-separator"></div>
              <button class="nav-item" data-page="recipes" data-i18n="nav_recipes">Recipes</button>
              <button class="nav-item" data-page="ingredients" data-i18n="nav_ingredients">Ingredients</button>
              <button class="nav-item" data-page="allergens" data-i18n="nav_allergens">Allergens</button>
              <div class="nav-separator"></div>
              <button class="nav-item" data-page="settings" data-i18n="nav_settings">‚öôÔ∏è Settings</button>
          </div>
      </div>
  </div>

  <div class="app-container">
    <main class="content">

      <!-- MENU PLANNING PAGE -->
      <div id="menu" class="page active">
        <div class="page-header">
          <h1 data-i18n="nav_menu">Menu Planning</h1>
          <div class="actions">
             <button class="btn btn-secondary" onclick="window.navigateTo('style-editor')" data-i18n="btn_customize">üìù Template Builder</button>
             <button class="btn btn-primary" onclick="window.printMenu()" data-i18n="btn_print">üñ®Ô∏è Print Menu</button>
          </div>
        </div>
        
        <!-- View Switcher & Calendar Controls -->
        <div class="calendar-controls">
           <div style="display: flex; gap: 10px;">
               <button class="btn btn-secondary active" id="monthlyViewBtn" data-i18n="btn_month_view">üìÜ Monthly</button>
               <button class="btn btn-secondary" id="weeklyViewBtn" data-i18n="btn_week_view">üìÖ Weekly</button>
           </div>
           <div style="display: flex; align-items: center; gap: 10px;">
               <button class="btn btn-secondary" onclick="window.changeMonth(-1)">‚Üê</button>
               <h2 id="currentMonth" style="margin: 0; min-width: 200px; text-align: center;">...</h2>
               <button class="btn btn-secondary" onclick="window.changeMonth(1)">‚Üí</button>
           </div>
        </div>
        
        <div id="calendar" class="week-view"></div>
      </div>

      <!-- RECIPES PAGE -->
      <div id="recipes" class="page">
        <div class="page-header">
          <h1 data-i18n="nav_recipes">Recipes</h1>
          <button class="btn btn-primary" onclick="window.openRecipeModal()" data-i18n="btn_add_recipe">+ Add Recipe</button>
        </div>
        <div class="filters-row" style="display:flex; gap:10px; margin-bottom:15px;">
            <input type="text" id="recipeSearch" class="form-control" style="max-width:300px;"
                data-i18n-placeholder="filter_search_placeholder"
                placeholder="Search recipes..."
                oninput="window.renderRecipes()">
            <select id="recipeCategoryFilter" class="form-control" style="max-width:200px;"
                onchange="window.renderRecipes()">
                <option value="" data-i18n="filter_all_categories">All Categories</option>
                <option value="soup" data-i18n="category_soup">ü•£ Soup</option>
                <option value="main" data-i18n="category_main">üçΩÔ∏è Main</option>
                <option value="dessert" data-i18n="category_dessert">üç∞ Dessert</option>
                <option value="other" data-i18n="category_other">‚ûï Other</option>
            </select>
        </div>
        <div class="table-responsive">
            <table class="list-table">
                <thead>
                    <tr>
                        <th id="recipeTh_name" class="sortable-th" onclick="window.setRecipeSort('name')" data-i18n="label_recipe_name">Name <span class="sort-arrow">‚Üë</span></th>
                        <th id="recipeTh_category" class="sortable-th" onclick="window.setRecipeSort('category')" data-i18n="label_category">Category <span class="sort-arrow">‚Üï</span></th>
                        <th id="recipeTh_portion" class="sortable-th" onclick="window.setRecipeSort('portion')" data-i18n="label_portion_size">Portion <span class="sort-arrow">‚Üï</span></th>
                        <th id="recipeTh_allergens" class="sortable-th" onclick="window.setRecipeSort('allergens')" data-i18n="label_allergens">Allergens <span class="sort-arrow">‚Üï</span></th>
                        <th data-i18n="table_actions">Actions</th>
                    </tr>
                </thead>
                <tbody id="recipeList"></tbody>
            </table>
        </div>
      </div>

      <!-- INGREDIENTS PAGE -->
      <div id="ingredients" class="page">
        <div class="page-header">
          <h1 data-i18n="nav_ingredients">Ingredients</h1>
          <button class="btn btn-primary" onclick="window.openIngredientModal()" data-i18n="btn_add_ingredient">+ Add Ingredient</button>
        </div>
        <div class="filters-row" style="display:flex; gap:10px; margin-bottom:15px;">
            <input type="text" id="ingredientSearch" class="form-control" style="max-width:300px;"
                data-i18n-placeholder="filter_search_placeholder"
                placeholder="Search ingredients..."
                oninput="window.renderIngredients()">
        </div>
        <div class="table-responsive">
            <table class="list-table">
                <thead>
                    <tr>
                        <th data-i18n="label_ingredient_name">Name</th>
                        <th data-i18n="label_allergens">Allergens</th>
                        <th data-i18n="table_actions">Actions</th>
                    </tr>
                </thead>
                <tbody id="ingredientList"></tbody>
            </table>
        </div>
      </div>

      <!-- ALLERGENS PAGE -->
      <div id="allergens" class="page">
        <div class="page-header">
          <h1 data-i18n="nav_allergens">Allergens</h1>
          <button class="btn btn-primary" onclick="window.openAllergenModal()" data-i18n="btn_add_allergen">+ Add Allergen</button>
        </div>
        <div class="table-responsive">
            <table class="list-table">
                <thead>
                    <tr>
                        <th data-i18n="label_allergen_name">Name</th>
                        <th data-i18n="label_color">Color</th>
                        <th data-i18n="table_actions">Actions</th>
                    </tr>
                </thead>
                <tbody id="allergenList"></tbody>
            </table>
        </div>
      </div>

      <!-- SETTINGS PAGE -->
      <div id="settings" class="page">
          <div class="page-header"><h1 data-i18n="heading_settings">Settings</h1></div>
          
          <!-- Storage Info Banner -->
          <div id="storage-info" class="settings-card" style="background: #e3f2fd; border-left: 4px solid #2196f3;">
              <h3 data-i18n="settings_storage_title">üíæ Storage Method</h3>
              <p id="storage-method-text" style="margin: 10px 0;">Loading...</p>
          </div>
          
          <div class="settings-card">
              <h3 data-i18n="heading_data">üíæ Data Management</h3>
              <button id="btn-change-folder" class="btn btn-primary" onclick="window.selectSaveLocation()" data-i18n="btn_change_folder">Change Storage Folder</button>
              <button id="btn-export" class="btn btn-secondary" onclick="window.exportAllData()" style="margin-top: 10px;" data-i18n="btn_export_backup">üíæ Export Data (Backup)</button>
              <input type="file" id="file-import" accept=".json" style="display:none;" onchange="window.importData(event)">
              <button id="btn-import" class="btn btn-secondary" onclick="document.getElementById('file-import').click()" style="margin-top: 10px;" data-i18n="btn_import_data">üìÇ Import Data</button>
          </div>
          
          <div class="settings-card">
              <h3 data-i18n="settings_archive_title">üìÅ PDF Archive</h3>
              <p style="color: #666; font-size: 0.9rem; margin-bottom: 10px;" data-i18n="settings_archive_desc">Printed menus are automatically saved to: archive/menus/</p>
              <button class="btn btn-secondary" onclick="window.openArchiveFolder()" data-i18n="btn_open_archive">Open Archive Folder</button>
          </div>
      </div>

      <!-- TEMPLATE BUILDER PAGE - NEW STEP-BASED VERSION -->
      <div id="style-editor" class="page">
        <div class="page-header">
          <button class="btn btn-secondary btn-small" onclick="window.navigateTo('menu')" data-i18n="btn_back_to_menu">‚Üê Back to Menu</button>
          <h1 data-i18n="nav_template_builder">üìù Template Builder</h1>
        </div>
        
        <div class="builder-layout" style="display: grid; grid-template-columns: 350px 1fr; gap: 20px; min-height: calc(100vh - 150px);">
             <!-- LEFT PANEL: Step-based Accordion Controls (auto-generated by template-builder-steps.js) -->
             <div id="template-sidebar" style="overflow-y: auto; background: white; border-radius: 8px; height: fit-content; max-height: calc(100vh - 180px);"></div>

             <!-- RIGHT PANEL: Live Preview -->
             <div style="background: #e9ecef; display: flex; justify-content: center; align-items: flex-start; padding: 20px; overflow-y: auto; border-radius: 8px;">
                  <div id="template-preview" style="width: 100%; max-width: 800px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 4px;"></div>
             </div>
      </div>

    </main>
  </div>

  <!-- MODALS -->
  <div id="recipeModal" class="modal">
      <div class="modal-content">
          <span class="close" onclick="window.closeRecipeModal()">&times;</span>
          <h2 id="recipeModalTitle" data-i18n="modal_add_recipe">Add Recipe</h2>
          <form id="recipeForm" onsubmit="window.saveRecipe(event)">
              <label data-i18n="label_recipe_name">Recipe Name</label>
              <input type="text" id="recipeName" class="form-control" required
                  data-i18n-placeholder="placeholder_recipe_name" placeholder="Recipe Name">
              
              <label data-i18n="label_category">Category</label>
              <select id="recipeCategory" class="form-control"></select>
              
              <label data-i18n="label_portion_size">Portion Size</label>
              <input type="text" id="recipePortionSize" class="form-control"
                  data-i18n-placeholder="placeholder_portion_size" placeholder="e.g., 250g">
              
              <label data-i18n="label_calories">Calories (optional)</label>
              <input type="number" id="recipeCalories" class="form-control"
                  data-i18n-placeholder="placeholder_calories" placeholder="e.g., 220">
              
              <label data-i18n="label_ingredients">Ingredients</label>
              <!-- Combobox: type-to-search ingredient picker -->
              <div class="combobox-wrapper" style="margin-bottom:10px;">
                  <input type="text" id="ingredientComboInput" class="form-control"
                         placeholder="Type to search ingredients..." autocomplete="off">
                  <ul id="ingredientComboDropdown" class="combobox-dropdown"></ul>
              </div>
              <div id="recipeIngredients" class="tag-container" style="margin-bottom:15px;"></div>
              
              <label data-i18n="label_auto_allergens">Auto-detected Allergens</label>
              <div id="recipeAutoAllergens" style="margin-bottom:15px; padding:10px; background:#f8f9fa; border-radius:4px; min-height:30px;">-</div>
              
              <label data-i18n="label_manual_allergens">Manual Allergens</label>
              <!-- Combobox: type-to-search allergen picker -->
              <div class="combobox-wrapper" style="margin-bottom:10px;">
                  <input type="text" id="allergenComboInput" class="form-control"
                         placeholder="Type to search allergens..." autocomplete="off">
                  <ul id="allergenComboDropdown" class="combobox-dropdown"></ul>
              </div>
              <div id="recipeManualAllergens" class="tag-container" style="margin-bottom:15px;"></div>
              
              <label data-i18n="label_instructions">Instructions</label>
              <textarea id="recipeInstructions" class="form-control" rows="4"
                  data-i18n-placeholder="placeholder_instructions" placeholder="Cooking instructions..."></textarea>
              
              <div style="margin-top:20px;">
                  <button type="submit" class="btn btn-primary" data-i18n="btn_save_recipe">Save Recipe</button>
                  <button type="button" class="btn btn-secondary" onclick="window.closeRecipeModal()" data-i18n="btn_cancel">Cancel</button>
              </div>
          </form>
      </div>
  </div>

  <div id="ingredientModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="window.closeIngredientModal()">&times;</span>
      <h2 id="ingredientModalTitle" data-i18n="modal_add_ingredient">Add Ingredient</h2>
      <form id="ingredientForm" onsubmit="window.saveIngredient(event)">
        <label data-i18n="label_ingredient_name">Ingredient Name</label>
        <input type="text" id="ingredientName" class="form-control" required
            data-i18n-placeholder="placeholder_ingredient_name" placeholder="Ingredient Name">
        
        <label data-i18n="label_allergens">Allergens</label>
        <!-- Combobox: type-to-search allergen picker -->
        <div class="combobox-wrapper" style="margin-bottom:10px;">
            <input type="text" id="ingAllergenComboInput" class="form-control"
                   placeholder="Type to search allergens..." autocomplete="off">
            <ul id="ingAllergenComboDropdown" class="combobox-dropdown"></ul>
        </div>
        <div id="ingredientLinkedAllergens" class="tag-container" style="margin-bottom:15px;"></div>
        
        <div style="margin-top:20px;">
            <button type="submit" class="btn btn-primary" data-i18n="btn_save_ingredient">Save Ingredient</button>
            <button type="button" class="btn btn-secondary" onclick="window.closeIngredientModal()" data-i18n="btn_cancel">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div id="allergenModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="window.closeAllergenModal()">&times;</span>
      <h2 id="allergenModalTitle" data-i18n="modal_add_allergen">Add Allergen</h2>
      <form id="allergenForm" onsubmit="window.saveAllergen(event)">
        <label data-i18n="label_allergen_name">Allergen Name</label>
        <input type="text" id="allergenName" class="form-control" required
            data-i18n-placeholder="placeholder_allergen_name" placeholder="Allergen Name">
        
        <label data-i18n="label_color">Color</label>
        <input type="color" id="allergenColor" class="form-control" value="#3498db">
        
        <div style="margin-top:20px;">
            <button type="submit" class="btn btn-primary" data-i18n="btn_save_allergen">Save Allergen</button>
            <button type="button" class="btn btn-secondary" onclick="window.closeAllergenModal()" data-i18n="btn_cancel">Cancel</button>
        </div>
      </form>
    </div>
  </div>
  
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        const storageInfo = document.getElementById('storage-method-text');
        const btnChangeFolder = document.getElementById('btn-change-folder');
        
        if (window.storageAdapter && storageInfo) {
          if (window.storageAdapter.useFileSystem) {
            const lang = window.getCurrentLanguage ? window.getCurrentLanguage() : 'bg';
            storageInfo.innerHTML = lang === 'bg'
              ? '<strong>File System API</strong><br>–í–∞—à–∏—Ç–µ –¥–∞–Ω–Ω–∏ —Å–µ –∑–∞–ø–∞–∑–≤–∞—Ç –≤ –ø–∞–ø–∫–∞ –Ω–∞ –≤–∞—à–∏—è –∫–æ–º–ø—é—Ç—ä—Ä.'
              : '<strong>File System API</strong><br>Your data is saved to a folder on your computer.';
          } else {
            const lang = window.getCurrentLanguage ? window.getCurrentLanguage() : 'bg';
            storageInfo.innerHTML = lang === 'bg'
              ? '<strong>IndexedDB (–ë—Ä–∞—É–∑—ä—Ä–Ω–∞ –ë–∞–∑–∞ –î–∞–Ω–Ω–∏)</strong><br>–í–∞—à–∏—Ç–µ –¥–∞–Ω–Ω–∏ —Å–µ —Å—ä—Ö—Ä–∞–Ω—è–≤–∞—Ç –≤ –±—Ä–∞—É–∑—ä—Ä–∞. –ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ –±—É—Ç–æ–Ω–∏—Ç–µ –ï–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç –∑–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ –∫–æ–ø–∏–µ.'
              : '<strong>IndexedDB (Browser Database)</strong><br>Your data is stored in your browser. Use Export/Import buttons to backup your data.';
            btnChangeFolder.style.display = 'none';
          }
        }
      }, 600);
    });
  </script>

</body>
</html>
